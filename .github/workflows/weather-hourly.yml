name: Hourly Weather Snapshot (IST ‚Äì Guaranteed)

on:
  schedule:
    - cron: "0 * * * *"   # runs every hour (UTC), logic handles IST safely
  workflow_dispatch:

jobs:
  collect-weather:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch & guarantee hourly data (IST)
        shell: bash
        run: |
          set -euo pipefail

          # ===============================
          # 0Ô∏è‚É£ FORCE IST (SINGLE SOURCE OF TRUTH)
          # ===============================
          export TZ=Asia/Kolkata

          NOW="$(date +"%Y-%m-%d %H:%M:%S")"
          CUR_DATE="$(date +"%Y-%m-%d")"
          CUR_HOUR="$(date +"%H")"
          CUR_TS="$(date -d "$CUR_DATE $CUR_HOUR:00" +%s)"

          echo "üïí IST NOW      = $NOW"
          echo "üìÖ CUR_DATE    = $CUR_DATE"
          echo "‚è∞ CUR_HOUR    = $CUR_HOUR"
          echo "üß≠ CUR_TS      = $CUR_TS"

          # ===============================
          # 1Ô∏è‚É£ FETCH API (retry-safe)
          # ===============================
          RAW=""
          for i in 1 2 3; do
            RAW=$(curl -fsS "https://api.ambientweather.net/v1/devices?apiKey=${{ secrets.API_KEY }}&applicationKey=${{ secrets.APP_KEY }}") && break
            sleep 10
          done

          API_OK=true
          if [ -z "$RAW" ] || [ "$RAW" = "[]" ]; then
            echo "‚ö†Ô∏è API unavailable ‚Äì using carry-forward"
            API_OK=false
          fi

          # ===============================
          # 2Ô∏è‚É£ FIND LAST STORED HOUR
          # ===============================
          LAST_FILE=$(ls data/device/hourly/*/*-00.json 2>/dev/null | sort | tail -n 1 || true)

          if [ -n "$LAST_FILE" ]; then
            LAST_DATE=$(basename "$(dirname "$LAST_FILE")")
            LAST_HOUR=$(basename "$LAST_FILE" | cut -d'-' -f1)
            LAST_TS=$(date -d "$LAST_DATE $LAST_HOUR:00" +%s)
            LAST_JSON=$(cat "$LAST_FILE")

            echo "üóÇ LAST_FILE   = $LAST_FILE"
            echo "‚è± LAST_TS     = $LAST_TS"
          else
            LAST_TS=$((CUR_TS - 3600))
            LAST_JSON=""
            echo "‚ÑπÔ∏è No previous files found"
          fi

          # ===============================
          # 3Ô∏è‚É£ GUARANTEE EVERY HOUR
          # ===============================
          TS=$LAST_TS

          while [ "$TS" -lt "$CUR_TS" ]; do
            TS=$((TS + 3600))

            D=$(date -d "@$TS" +"%Y-%m-%d")
            H=$(date -d "@$TS" +"%H")

            DIR="data/device/hourly/$D"
            FILE="$DIR/$H-00.json"

            mkdir -p "$DIR"

            if [ -f "$FILE" ]; then
              echo "‚úî Exists $FILE"
              continue
            fi

            echo "‚ûï Creating $FILE"

            if [ "$API_OK" = true ]; then
              echo "$RAW" | jq '.[0].lastData | {
                timestamp: .date,
                source: "ambientweather-api",

                outdoor: {
                  temperature: ((.tempf - 32) * 5 / 9),
                  feelsLike: ((.feelsLike - 32) * 5 / 9),
                  dewPoint: ((.dewPoint - 32) * 5 / 9),
                  humidity: .humidity
                },

                wind: {
                  speed: (.windspeedmph * 1.60934),
                  gust: (.windgustmph * 1.60934),
                  maxDailyGust: (.maxdailygust * 1.60934),
                  directionDeg: .winddir
                },

                rain: {
                  hourly: (.hourlyrainin * 25.4),
                  daily: (.dailyrainin * 25.4),
                  weekly: (.weeklyrainin * 25.4)
                },

                pressure: {
                  relative: (.baromrelin * 33.8639),
                  absolute: (.baromabsin * 33.8639)
                },

                indoor: {
                  temperature: ((.tempinf - 32) * 5 / 9),
                  humidity: .humidityin
                },

                solar: {
                  uv: .uv,
                  radiation: .solarradiation
                }
              }' > "$FILE"
            else
              if [ -n "$LAST_JSON" ]; then
                echo "$LAST_JSON" | jq '. + { source: "carry-forward" }' > "$FILE"
              else
                echo "‚ùå No data available to carry forward"
              fi
            fi
          done

      - name: Commit and push
        run: |
          git config user.name "goodearth-weather-bot"
          git config user.email "weather-bot@goodearth.internal"
          git add data/device/hourly
          git commit -m "Guaranteed hourly weather snapshot (IST)" || echo "No changes"
          git push
